<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.0.xsd">
                    
    <global-method-security pre-post-annotations="enabled">
        <!-- AspectJ pointcut expression that locates our "post" method and applies security that way
        <protect-pointcut expression="execution(* bigbank.*Service.post*(..))" access="ROLE_TELLER"/>
        -->
    </global-method-security>
		
		<!--   <http pattern="/css/**" security="none"/>
		 <http pattern="/templates/**" security="none"/>
		  <http pattern="/service/**" security="none"/>
		   <http pattern="/scripts/**" security="none"/> -->
		   	
    <http use-expressions="true">
    	
    	<intercept-url pattern="/css/**" filters="none" />
    	<intercept-url pattern="/templates/**" filters="none" />
    	<intercept-url pattern="/scripts/**" filters="none" />
    	<intercept-url pattern="/service/**" filters="none" />
    	
    	
        <intercept-url pattern="/admin/**" access="hasRole('ADMINISTRATOR')" />
        <intercept-url pattern="/list**" access="isFullyAuthenticated()" />
        <intercept-url pattern="/add**" access="hasAnyRole('ADMINISTRATOR','SUPPORT')" />
        <intercept-url pattern="/search**" access="hasAnyRole('ADMINISTRATOR','HELPDESK','SUPPORT')" />
        <intercept-url pattern="/delete**" access="hasRole('ADMINISTRATOR')" />
        <intercept-url pattern="/create**" access="hasAnyRole('ADMINISTRATOR','SUPPORT')" />
        <intercept-url pattern="/mainMenu.html" access="isFullyAuthenticated()" />
        <intercept-url pattern="/listDocument.html" access="hasAnyRole('ADMINISTRATOR','OTHERS')" />
        <intercept-url pattern="/createUserForm.html" access="hasAnyRole('ADMINISTRATOR','SUPPORT')" />
     	<intercept-url pattern="/listUsermaster.html" access="hasAnyRole('ADMINISTRATOR','HELPDESK','SUPPORT')" />
        <intercept-url pattern="/reportUser.html" access="hasRole('ADMINISTRATOR')" />
        <intercept-url pattern="/prtreprint*" access="hasRole('ADMINISTRATOR')" />
        <intercept-url pattern="/usermanager**" access="hasAnyRole('ADMINISTRATOR','SUPPORT')" />
        <intercept-url pattern="/WEB-INF/index.jsp" access="isFullyAuthenticated()" />
        <intercept-url pattern="/createUserForm.html" access="hasAnyRole('ADMINISTRATOR','SUPPORT')" />
        <form-login login-page="/auth/login.html" authentication-success-handler-ref="authenticationSuccessHandler" authentication-failure-url = "/auth/login.html?login_error=1" authentication-failure-handler-ref="myLoginFailureHandler" />
        <logout invalidate-session="true"  logout-url="/j_spring_security_logout"  success-handler-ref="myLogoutSuccessHandler" />
        <access-denied-handler error-page="/WEB-INF/pages/error/403.jsp"/>
        <remember-me />

        <!-- Uncomment to limit the number of sessions a user can have -->
        <session-management invalid-session-url="/auth/login.html">
            <concurrency-control max-sessions="1" error-if-maximum-exceeded="false" />
        </session-management>
    </http>
    
    <authentication-manager>
		<authentication-provider>
			<password-encoder ref="SHAPasswordEncoder"/>
			<jdbc-user-service data-source-ref="dataSource"
			users-by-username-query="select u.username, u.password, 1 as enabled, u.user_place from usermaster u where u.username = ?"
			authorities-by-username-query="select u.username, a.role_name as authority, u.user_place
											from usermaster u, user_role_m a 
											where u.role_id = a.id and 
											u.username = ?"/>
		</authentication-provider>
    </authentication-manager>
    
    <beans:bean id="SHAPasswordEncoder" class="com.pruvn.tools.utils.SHAPasswordEncoder" />
	
	<beans:bean id="dataSource" class="org.springframework.jndi.JndiObjectFactoryBean">
	    <beans:property name="jndiName" value="java:comp/env/jdbc/CFCLongDevDB" />
	</beans:bean>
	
	<beans:bean id="myLogoutSuccessHandler" class="com.pruvn.tools.printserver.webapp.controller.MyLogoutSuccessHandler">
    <beans:property name="defaultTargetUrl" value="/" ></beans:property>
    <beans:property name="alwaysUseDefaultTargetUrl" value="true"></beans:property>
    <beans:property name="usermasterlogDAO" ref="usermasterlogDAO"  ></beans:property>
     </beans:bean>
     <beans:bean id="myLoginFailureHandler" class="com.pruvn.tools.printserver.webapp.controller.MyLoginFailureHandler">
         <beans:property name="defaultFailureUrl" value="/auth/login.html?login_error=1" ></beans:property>
         <beans:property name="minutesLimitLogin" value="2" ></beans:property>
         <beans:property name="maxCountLogin" value="3" ></beans:property>
         <beans:property name="usermasterDAO" ref="usermasterDAO" ></beans:property>
         <beans:property name="usermasterlogDAO" ref="usermasterlogDAO"  ></beans:property>
     </beans:bean>

	
	
	<beans:bean id="authenticationSuccessHandler" class="com.pruvn.tools.printserver.handler.AuthenticationSuccessHandler">
	    <beans:property name="parammasterDAO" ref="parammasterDAO" />
	</beans:bean>
	
</beans:beans>
